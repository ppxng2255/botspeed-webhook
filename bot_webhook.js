const express = require("express");
const bodyParser = require("body-parser");

const app = express();
app.use(bodyParser.json());

// ðŸ”¹ à¸„à¸³à¸•à¸­à¸šà¹à¸šà¸šà¸ªà¸¸à¹ˆà¸¡à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸•à¹ˆà¸¥à¸° Intent
const responsesSayHi = [
    "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸² Speedà¹‚à¸¡à¹ˆà¸ˆà¸°à¸¡à¸²à¸Šà¹ˆà¸§à¸¢à¹à¸™à¸°à¸™à¸³à¸„à¹ˆà¸²à¸¢à¹€à¸™à¹‡à¸•à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸žà¸µà¹ˆà¹† à¸£à¸šà¸à¸§à¸™à¸šà¸­à¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¹ˆà¸°",
    "à¹€à¸®à¸¥à¹‚à¸¥à¹ˆ~ Speedà¹‚à¸¡à¹ˆà¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸«à¹‰à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸„à¹ˆà¸²à¸¢à¹€à¸™à¹‡à¸•à¹€à¸¥à¸¢à¸„à¹ˆà¸°! à¸£à¸°à¸šà¸¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¹ƒà¸«à¹‰à¸«à¸™à¹ˆà¸­à¸¢à¸™à¸°à¸„à¸°",
    "à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸šà¸„à¹ˆà¸²! Speedà¹‚à¸¡à¹ˆà¸ˆà¸°à¸Šà¹ˆà¸§à¸¢à¸«à¸²à¸„à¹ˆà¸²à¸¢à¹€à¸™à¹‡à¸•à¸—à¸µà¹ˆà¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹ƒà¸«à¹‰à¸žà¸µà¹ˆà¹† à¸šà¸­à¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹€à¸¥à¸¢à¸„à¹ˆà¸°"
];

const responsesAskLocation = [
    "à¹‚à¸­à¹€à¸„à¸„à¹ˆà¸°! à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¹€à¸™à¹‡à¸•à¸—à¸µà¹ˆà¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¹„à¸«à¸™à¸„à¸°? (à¹€à¸Šà¹ˆà¸™ à¸à¸£à¸¸à¸‡à¹€à¸—à¸ž, à¹€à¸Šà¸µà¸¢à¸‡à¹ƒà¸«à¸¡à¹ˆ, à¸¯à¸¥à¸¯)",
    "à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°! à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¹€à¸™à¹‡à¸•à¸„à¹ˆà¸°",
    "à¸„à¹ˆà¸°! à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸«à¹‰à¹à¸™à¸°à¸™à¸³à¹€à¸™à¹‡à¸•à¸„à¹ˆà¸°"
];

const responsesAskTypes = [
    "à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¹€à¸™à¹‡à¸•à¸—à¸³à¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡à¸„à¸°? (à¸”à¸¹à¸«à¸™à¸±à¸‡, à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡, à¸—à¸³à¸‡à¸²à¸™, à¸¯à¸¥à¸¯)",
    "à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸à¸²à¸£à¹ƒà¸Šà¹‰à¹€à¸™à¹‡à¸•à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¹ˆà¸° à¹€à¸Šà¹ˆà¸™ Netflix, à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡, à¸›à¸£à¸°à¸Šà¸¸à¸¡à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ, à¸¯à¸¥à¸¯",
    "à¸ªà¹ˆà¸§à¸™à¹ƒà¸«à¸à¹ˆà¹ƒà¸Šà¹‰à¹€à¸™à¹‡à¸•à¸—à¸³à¸­à¸°à¹„à¸£à¸„à¸°? à¸šà¸­à¸à¸™à¹‰à¸­à¸‡Speedà¹‚à¸¡à¹ˆà¸«à¸™à¹ˆà¸­à¸¢à¸„à¹ˆà¸° à¹€à¸Šà¹ˆà¸™ à¸—à¸³à¸˜à¸¸à¸£à¸°, à¹€à¸—à¸µà¹ˆà¸¢à¸§, à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡, à¸¯à¸¥à¸¯"
];

const responsesAskLocationYes = [
    "à¸™à¹‰à¸­à¸‡à¸¢à¸´à¸™à¸”à¸µà¹ƒà¸«à¹‰à¸„à¸³à¹à¸™à¸°à¸™à¸³à¹€à¸žà¸´à¹ˆà¸¡à¸„à¹ˆà¸° à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¹ˆà¸°",
    "à¸ˆà¸±à¸”à¹„à¸›à¸„à¹ˆà¸°! à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸«à¹‰Speedà¹‚à¸¡à¹ˆà¹à¸™à¸°à¸™à¸³à¹€à¸™à¹‡à¸•à¸„à¹ˆà¸°",
    "à¸¥à¸¸à¸¢à¸¢! à¸¡à¸µà¸­à¸µà¸à¹„à¸«à¸¡à¸„à¸°? à¸šà¸­à¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¹ˆà¸°"
];

const responsesNoGoodbye = [
    "à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰ Speedà¹‚à¸¡à¹ˆà¸„à¹ˆà¸°! à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¸³à¹à¸™à¸°à¸™à¸³à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ à¸—à¸±à¸à¸™à¹‰à¸­à¸‡Speedà¹‚à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸ªà¸¡à¸­à¸„à¹ˆà¸°",
    "à¸‚à¸­à¸šà¸„à¸¸à¸“à¸„à¹ˆà¸²à¸² à¸”à¸µà¹ƒà¸ˆà¸—à¸µà¹ˆà¸™à¹‰à¸­à¸‡à¹‚à¸¡à¹ˆà¹„à¸”à¹‰à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­à¸™à¸°à¸„à¸°",
    "à¸à¸¥à¸±à¸šà¸¡à¸²à¹„à¸”à¹‰à¹€à¸ªà¸¡à¸­à¸™à¸°à¸„à¸° à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰ Speedà¹‚à¸¡à¹ˆà¸„à¹ˆà¸°"
];

// ðŸ”¹ à¹à¸šà¹ˆà¸‡à¸ à¸¹à¸¡à¸´à¸ à¸²à¸„à¸‚à¸­à¸‡à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”
const regions = {
    "à¹€à¸«à¸™à¸·à¸­": ["à¹€à¸Šà¸µà¸¢à¸‡à¹ƒà¸«à¸¡à¹ˆ", "à¹€à¸Šà¸µà¸¢à¸‡à¸£à¸²à¸¢", "à¸¥à¸³à¸›à¸²à¸‡", "à¸¥à¸³à¸žà¸¹à¸™"],
    "à¸à¸¥à¸²à¸‡": ["à¸à¸£à¸¸à¸‡à¹€à¸—à¸žà¸¡à¸«à¸²à¸™à¸„à¸£", "à¸™à¸™à¸—à¸šà¸¸à¸£à¸µ", "à¸›à¸—à¸¸à¸¡à¸˜à¸²à¸™à¸µ"],
    "à¸­à¸µà¸ªà¸²à¸™": ["à¸‚à¸­à¸™à¹à¸à¹ˆà¸™", "à¸™à¸„à¸£à¸£à¸²à¸Šà¸ªà¸µà¸¡à¸²", "à¸­à¸¸à¸šà¸¥à¸£à¸²à¸Šà¸˜à¸²à¸™à¸µ"],
    "à¹ƒà¸•à¹‰": ["à¸ à¸¹à¹€à¸à¹‡à¸•", "à¸ªà¸¸à¸£à¸²à¸©à¸Žà¸£à¹Œà¸˜à¸²à¸™à¸µ", "à¸ªà¸‡à¸‚à¸¥à¸²"],
    "à¸•à¸°à¸§à¸±à¸™à¸­à¸­à¸": ["à¸Šà¸¥à¸šà¸¸à¸£à¸µ", "à¸£à¸°à¸¢à¸­à¸‡", "à¸ˆà¸±à¸™à¸—à¸šà¸¸à¸£à¸µ"],
    "à¸•à¸°à¸§à¸±à¸™à¸•à¸": ["à¸à¸²à¸à¸ˆà¸™à¸šà¸¸à¸£à¸µ", "à¸£à¸²à¸Šà¸šà¸¸à¸£à¸µ", "à¹€à¸žà¸Šà¸£à¸šà¸¸à¸£à¸µ"]
};

// ðŸ”¹ à¸£à¸°à¸”à¸±à¸šà¸à¸²à¸£à¹ƒà¸Šà¹‰à¹€à¸™à¹‡à¸•
const usageLevels = {
    "à¸”à¸¹à¸«à¸™à¸±à¸‡": "à¸¡à¸²à¸",
    "à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡": "à¸¡à¸²à¸",
    "à¹€à¸£à¸µà¸¢à¸™à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ": "à¸¡à¸²à¸",
    "à¸—à¸³à¸‡à¸²à¸™": "à¸›à¸²à¸™à¸à¸¥à¸²à¸‡",
    "à¹‚à¸‹à¹€à¸Šà¸µà¸¢à¸¥à¸¡à¸µà¹€à¸”à¸µà¸¢": "à¸™à¹‰à¸­à¸¢",
    "à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œ": "à¸™à¹‰à¸­à¸¢"
};

// ðŸ”¹ à¹à¸™à¸°à¸™à¸³à¸­à¸´à¸™à¹€à¸—à¸­à¸£à¹Œà¹€à¸™à¹‡à¸•à¸•à¸²à¸¡à¸ à¸¹à¸¡à¸´à¸ à¸²à¸„à¹à¸¥à¸°à¸£à¸°à¸”à¸±à¸šà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™
const recommendations = {
    "à¹€à¸«à¸™à¸·à¸­": {
        "à¸¡à¸²à¸": "Speedà¹‚à¸¡à¹ˆà¹à¸™à¸°à¸™à¸³ **True 5G Ultra Max** ðŸš€",
        "à¸›à¸²à¸™à¸à¸¥à¸²à¸‡": "Speedà¹‚à¸¡à¹ˆà¹à¸™à¸°à¸™à¸³ **AIS Work Pro** ðŸ’¼",
        "à¸™à¹‰à¸­à¸¢": "Speedà¹‚à¸¡à¹ˆà¹à¸™à¸°à¸™à¸³ **Dtac Social Hero** ðŸ“±"
    },
    "à¸à¸¥à¸²à¸‡": {
        "à¸¡à¸²à¸": "Speedà¹‚à¸¡à¹ˆà¹à¸™à¸°à¸™à¸³ **AIS Max Speed 5G** âš¡",
        "à¸›à¸²à¸™à¸à¸¥à¸²à¸‡": "Speedà¹‚à¸¡à¹ˆà¹à¸™à¸°à¸™à¸³ **AIS Business Fiber** ðŸ¡",
        "à¸™à¹‰à¸­à¸¢": "Speedà¹‚à¸¡à¹ˆà¹à¸™à¸°à¸™à¸³ **Dtac Unlimited Social** ðŸ“²"
    }
};

// ðŸ”¹ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¹à¸•à¹ˆà¸¥à¸° Intent
function sayHi(req, res) {
    res.json({ fulfillmentText: responsesSayHi[Math.floor(Math.random() * responsesSayHi.length)], outputContexts: [
        { name: req.body.session + "/contexts/askLocation", lifespanCount: 5 }
    ]});
}

function askLocation(req, res) {
    res.json({ fulfillmentText: responsesAskLocation[Math.floor(Math.random() * responsesAskLocation.length)], outputContexts: [
        { name: req.body.session + "/contexts/askTypes", lifespanCount: 1 }
    ]});
}

function askTypes(req, res) {
    const location = req.body.queryResult.parameters.location_name || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸";
    const usage = req.body.queryResult.parameters.types_use || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸";

    let region = "default";
    for (const [key, value] of Object.entries(regions)) {
        if (value.includes(location)) {
            region = key;
            break;
        }
    }

    const usageLevel = usageLevels[usage] || "default";
    const recommendation = recommendations[region]?.[usageLevel] || "Speedà¹‚à¸¡à¹ˆà¹à¸™à¸°à¸™à¸³ **AIS 5G à¸«à¸£à¸·à¸­ True 5G** à¸—à¸µà¹ˆà¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸—à¸¸à¸à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸„à¹ˆà¸°!";

    res.json({ fulfillmentText: `${recommendation} ðŸš€ à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹à¸™à¸°à¸™à¸³à¹€à¸žà¸´à¹ˆà¸¡à¹„à¸«à¸¡? (Yes/No)` });
}

function askLocationYes(req, res) {
    res.json({ fulfillmentText: responsesAskLocationYes[Math.floor(Math.random() * responsesAskLocationYes.length)], outputContexts: [
        { name: req.body.session + "/contexts/askLocation", lifespanCount: 5 }
    ]});
}

function noGoodbye(req, res) {
    res.json({ fulfillmentText: responsesNoGoodbye[Math.floor(Math.random() * responsesNoGoodbye.length)] });
}

// ðŸ”¹ Webhook Endpoint
app.post("/webhook", (req, res) => {
    const intent = req.body.queryResult.intent.displayName;

    // ðŸ”¹ Map Intent à¸à¸±à¸š Function à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰
    const intentMap = new Map();
    intentMap.set("sayhi", sayHi);
    intentMap.set("ask_location", askLocation);
    intentMap.set("ask_types", askTypes);
    intentMap.set("ask_location-yes", askLocationYes);
    intentMap.set("no-goodbye", noGoodbye);

    if (intentMap.has(intent)) {
        intentMap.get(intent)(req, res);
    } else {
        res.json({ fulfillmentText: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° Speedà¹‚à¸¡à¹ˆà¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸„à¸³à¸‚à¸­à¸‚à¸­à¸‡à¸„à¸¸à¸“ ðŸ˜¢" });
    }
});

// ðŸ”¹ à¹€à¸›à¸´à¸”à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
    console.log(`ðŸš€ Webhook is running on port ${PORT}`);
});
