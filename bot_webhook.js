const express = require("express");
const bodyParser = require("body-parser");

const app = express();
app.use(bodyParser.json());

// ðŸ”¹ à¸„à¸³à¸•à¸­à¸šà¹à¸šà¸šà¸ªà¸¸à¹ˆà¸¡à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸•à¹ˆà¸¥à¸° Intent
const responsesSayHi = [
    "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸² à¸™à¹‰à¸­à¸‡Speedà¹‚à¸¡à¹ˆðŸ® à¸ˆà¸°à¸¡à¸²à¸Šà¹ˆà¸§à¸¢à¹à¸™à¸°à¸™à¸³à¸„à¹ˆà¸²à¸¢à¹€à¸™à¹‡à¸•à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸žà¸µà¹ˆà¹† à¸£à¸šà¸à¸§à¸™à¸šà¸­à¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸—à¸µà¹ˆà¸­à¸¢à¸²à¸à¸—à¸£à¸²à¸šà¹„à¸”à¹‰à¹€à¸¥à¸¢à¸„à¹ˆà¸²",
    "à¹€à¸®à¸¥à¹‚à¸¥à¹ˆ~ðŸ‘‹ à¸™à¹‰à¸­à¸‡Speedà¹‚à¸¡à¹ˆðŸ® à¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸«à¹‰à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸„à¹ˆà¸²à¸¢à¹€à¸™à¹‡à¸•à¸¡à¸²à¸à¹†à¸„à¹ˆà¸° à¸£à¸šà¸à¸§à¸™à¸£à¸°à¸šà¸¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¹ƒà¸«à¹‰à¸«à¸™à¹ˆà¸­à¸¢à¸™à¸°à¸„à¸°",
    "à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸šà¸„à¹ˆà¸²ðŸ¤© à¸™à¹‰à¸­à¸‡Speedà¹‚à¸¡à¹ˆðŸ® à¸ˆà¸°à¸Šà¹ˆà¸§à¸¢à¸«à¸²à¸„à¹ˆà¸²à¸¢à¹€à¸™à¹‡à¸•à¸—à¸µà¹ˆà¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹ƒà¸«à¹‰à¸žà¸µà¹ˆà¹† à¸šà¸­à¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¸¡à¸²à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸„à¹ˆà¸°"
];

const responsesAskLocationYes = [
    "à¸™à¹‰à¸­à¸‡à¸¢à¸´à¸™à¸”à¸µà¹ƒà¸«à¹‰à¸„à¸³à¹à¸™à¸°à¸™à¸³à¹€à¸žà¸´à¹ˆà¸¡à¸„à¹ˆà¸° à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¹ˆà¸°",
    "à¸ˆà¸±à¸”à¹„à¸›à¸„à¹ˆà¸°! à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸«à¹‰Speedà¹‚à¸¡à¹ˆà¹à¸™à¸°à¸™à¸³à¹€à¸™à¹‡à¸•à¸„à¹ˆà¸°",
    "à¸¥à¸¸à¸¢à¸¢! à¸¡à¸µà¸­à¸µà¸à¹„à¸«à¸¡à¸„à¸°? à¸šà¸­à¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¹ˆà¸°"
];

const responsesNoGoodbye = [
    "à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰ à¸™à¹‰à¸­à¸‡Speedà¹‚à¸¡à¹ˆà¸„à¹ˆà¸°! à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¸³à¹à¸™à¸°à¸™à¸³à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ à¸—à¸±à¸à¸™à¹‰à¸­à¸‡Speedà¹‚à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸ªà¸¡à¸­à¸™à¹‰à¸²à¸²à¸²à¸²à¸²â¤ï¸",
    "à¸‚à¸­à¸šà¸„à¸¸à¸“à¸„à¹ˆà¸²à¸² à¸”à¸µà¹ƒà¸ˆà¸—à¸µà¹ˆà¸™à¹‰à¸­à¸‡à¹‚à¸¡à¹ˆà¹„à¸”à¹‰à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­à¸™à¸°à¸„à¸° à¸à¸²à¸à¸šà¸­à¸à¸•à¹ˆà¸­à¸”à¹‰à¸§à¸¢à¸™à¸°à¸„à¸°ðŸ®",
    "à¸à¸¥à¸±à¸šà¸¡à¸²à¹„à¸”à¹‰à¹€à¸ªà¸¡à¸­à¸™à¸°à¸„à¸° à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰ Speedà¹‚à¸¡à¹ˆà¸„à¹ˆà¸°ðŸ˜"
];

// ðŸ”¹ à¹à¸šà¹ˆà¸‡à¸ à¸¹à¸¡à¸´à¸ à¸²à¸„à¸‚à¸­à¸‡à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”
const regions = {
    "à¹€à¸«à¸™à¸·à¸­": ["à¹€à¸Šà¸µà¸¢à¸‡à¹ƒà¸«à¸¡à¹ˆ", "à¹€à¸Šà¸µà¸¢à¸‡à¸£à¸²à¸¢", "à¸¥à¸³à¸›à¸²à¸‡", "à¸¥à¸³à¸žà¸¹à¸™","à¹à¸¡à¹ˆà¸®à¹ˆà¸­à¸‡à¸ªà¸­à¸™","à¸™à¹ˆà¸²à¸™","à¸žà¸°à¹€à¸¢à¸²","à¹à¸žà¸£à¹ˆ","à¸­à¸¸à¸•à¸£à¸”à¸´à¸•à¸–à¹Œ"],
    "à¸à¸¥à¸²à¸‡": ["à¸žà¸´à¸©à¸“à¸¸à¹‚à¸¥à¸", "à¸žà¸´à¸ˆà¸´à¸•à¸£", "à¹€à¸žà¸Šà¸£à¸šà¸¹à¸£à¸“à¹Œ", "à¸™à¸„à¸£à¸ªà¸§à¸£à¸£à¸„à¹Œ", "à¸­à¸¸à¸—à¸±à¸¢à¸˜à¸²à¸™à¸µ", "à¸à¸³à¹à¸žà¸‡à¹€à¸žà¸Šà¸£", "à¸ªà¸¸à¹‚à¸‚à¸—à¸±à¸¢", "à¸ªà¸¡à¸¸à¸—à¸£à¸ªà¸²à¸„à¸£","à¸ªà¸¡à¸¸à¸—à¸£à¸›à¸£à¸²à¸à¸²à¸£", "à¸ªà¸¡à¸¸à¸—à¸£à¸ªà¸‡à¸„à¸£à¸²à¸¡", "à¸™à¸„à¸£à¸›à¸à¸¡", "à¸à¸£à¸¸à¸‡à¹€à¸—à¸žà¸¡à¸«à¸²à¸™à¸„à¸£", "à¸™à¸™à¸—à¸šà¸¸à¸£à¸µ", "à¸›à¸—à¸¸à¸¡à¸˜à¸²à¸™à¸µ","à¸žà¸£à¸°à¸™à¸„à¸£à¸¨à¸£à¸µà¸­à¸¢à¸¸à¸˜à¸¢à¸²", "à¸­à¹ˆà¸²à¸‡à¸—à¸­à¸‡", "à¸¥à¸žà¸šà¸¸à¸£à¸µ", "à¸ªà¸´à¸‡à¸«à¹Œà¸šà¸¸à¸£à¸µ", "à¸Šà¸±à¸¢à¸™à¸²à¸—", "à¸ªà¸£à¸°à¸šà¸¸à¸£à¸µ"],
    "à¸­à¸µà¸ªà¸²à¸™": ["à¸‚à¸­à¸™à¹à¸à¹ˆà¸™", "à¸™à¸„à¸£à¸£à¸²à¸Šà¸ªà¸µà¸¡à¸²", "à¸­à¸¸à¸šà¸¥à¸£à¸²à¸Šà¸˜à¸²à¸™à¸µ", "à¸šà¸¸à¸£à¸µà¸£à¸±à¸¡à¸¢à¹Œ", "à¸ªà¸¸à¸£à¸´à¸™à¸—à¸£à¹Œ", "à¸¨à¸£à¸µà¸ªà¸°à¹€à¸à¸©", "à¸­à¸¸à¸”à¸£à¸˜à¸²à¸™à¸µ", "à¸¢à¹‚à¸ªà¸˜à¸£","à¸Šà¸±à¸¢à¸ à¸¹à¸¡à¸´", "à¸­à¸³à¸™à¸²à¸ˆà¹€à¸ˆà¸£à¸´à¸", "à¸«à¸™à¸­à¸‡à¸šà¸±à¸§à¸¥à¸³à¸ à¸¹", "à¸£à¹‰à¸­à¸¢à¹€à¸­à¹‡à¸”", "à¸¡à¸«à¸²à¸ªà¸²à¸£à¸„à¸²à¸¡", "à¸à¸²à¸¬à¸ªà¸´à¸™à¸˜à¸¸à¹Œ", "à¸ªà¸à¸¥à¸™à¸„à¸£", "à¸™à¸„à¸£à¸žà¸™à¸¡", "à¸¡à¸¸à¸à¸”à¸²à¸«à¸²à¸£","à¹€à¸¥à¸¢", "à¸šà¸¶à¸‡à¸à¸²à¸¬", "à¸«à¸™à¸­à¸‡à¸„à¸²à¸¢"],
    "à¹ƒà¸•à¹‰": ["à¸ à¸¹à¹€à¸à¹‡à¸•", "à¸ªà¸¸à¸£à¸²à¸©à¸Žà¸£à¹Œà¸˜à¸²à¸™à¸µ", "à¸ªà¸‡à¸‚à¸¥à¸²","à¸Šà¸¸à¸¡à¸žà¸£","à¸£à¸°à¸™à¸­à¸‡","à¸™à¸„à¸£à¸¨à¸£à¸µà¸˜à¸£à¸£à¸¡à¸£à¸²à¸Š","à¸à¸£à¸°à¸šà¸µà¹ˆ","à¸žà¸±à¸‡à¸‡à¸²","à¸žà¸±à¸—à¸¥à¸¸à¸‡","à¸•à¸£à¸±à¸‡","à¸›à¸±à¸•à¸•à¸²à¸™à¸µ","à¸ªà¸•à¸¹à¸¥","à¸™à¸£à¸²à¸˜à¸´à¸§à¸²à¸ª","à¸¢à¸°à¸¥à¸²"],
    "à¸•à¸°à¸§à¸±à¸™à¸­à¸­à¸": ["à¸Šà¸¥à¸šà¸¸à¸£à¸µ", "à¸£à¸°à¸¢à¸­à¸‡", "à¸ˆà¸±à¸™à¸—à¸šà¸¸à¸£à¸µ","à¸ªà¸£à¸°à¹à¸à¹‰à¸§","à¸›à¸£à¸²à¸ˆà¸µà¸™à¸šà¸¸à¸£à¸µ","à¸‰à¸°à¹€à¸Šà¸´à¸‡à¹€à¸—à¸£à¸²","à¸•à¸£à¸²à¸”"],
    "à¸•à¸°à¸§à¸±à¸™à¸•à¸": ["à¸à¸²à¸à¸ˆà¸™à¸šà¸¸à¸£à¸µ", "à¸£à¸²à¸Šà¸šà¸¸à¸£à¸µ", "à¹€à¸žà¸Šà¸£à¸šà¸¸à¸£à¸µ","à¸•à¸²à¸","à¸›à¸£à¸°à¸ˆà¸§à¸šà¸„à¸µà¸£à¸µà¸‚à¸±à¸™à¸˜à¹Œ"]
};

// ðŸ”¹ à¹à¸™à¸°à¸™à¸³à¸­à¸´à¸™à¹€à¸—à¸­à¸£à¹Œà¹€à¸™à¹‡à¸•à¸•à¸²à¸¡à¸ à¸¹à¸¡à¸´à¸ à¸²à¸„à¹à¸¥à¸°à¸£à¸°à¸”à¸±à¸šà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™
const recommendations = {
    "à¹€à¸«à¸™à¸·à¸­": "Speedà¹‚à¸¡à¹ˆ à¸‚à¸­à¹à¸™à¸°à¸™à¸³ ðŸŒˆ**True 5G Ultra Max** à¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ à¸¹à¹€à¸‚à¸²à¹€à¸¢à¸­à¸°à¹† ðŸ”ï¸ ",
    "à¸à¸¥à¸²à¸‡": "Speedà¹‚à¸¡à¹ˆ à¸‚à¸­à¹à¸™à¸°à¸™à¸³ ðŸš©**AIS Max Speed 5G** à¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹ƒà¸™à¹€à¸¡à¸·à¸­à¸‡ à¸„à¸™à¹à¸­à¸­à¸±à¸” ðŸš„ ",
    "à¸­à¸µà¸ªà¸²à¸™": "Speedà¹‚à¸¡à¹ˆ à¸‚à¸­à¹à¸™à¸°à¸™à¸³ ðŸŒ€**Dtac Turbo Gaming**  à¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸£à¸²à¸š à¹à¸–à¸§à¸ à¸²à¸„à¸­à¸µà¸ªà¸²à¸™ ðŸ•ï¸",
    "à¹ƒà¸•à¹‰": "Speedà¹‚à¸¡à¹ˆà¸‚à¸­ à¹à¸™à¸°à¸™à¸³ ðŸŒˆ**True 5G Super Max**  à¸ªà¸³à¸«à¸£à¸±à¸šà¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸Šà¸²à¸¢à¸à¸±à¹ˆà¸‡à¹à¸¥à¸°à¸šà¸™à¹€à¸à¸²à¸° à¸„à¸™à¹€à¸¢à¸­à¸° ðŸ¥¥",
    "à¸•à¸°à¸§à¸±à¸™à¸­à¸­à¸": "Speedà¹‚à¸¡à¹ˆà¸‚à¸­ à¹à¸™à¸°à¸™à¸³ ðŸŒ€**Dtac 5G Ultra Max** à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¹ƒà¸Šà¹‰à¹€à¸™à¹‡à¸•à¸›à¸²à¸™à¸à¸¥à¸²à¸‡ ",
    "à¸•à¸°à¸§à¸±à¸™à¸•à¸": "Speedà¹‚à¸¡à¹ˆà¸‚à¸­ à¹à¸™à¸°à¸™à¸³ ðŸš©**AIS 5G Ultra Max**  à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§à¸ªà¸¹à¸‡ âš¡"
};


function sayHi(req, res) {
    res.json({
        fulfillmentText: responsesSayHi[Math.floor(Math.random() * responsesSayHi.length)],
        outputContexts: [{ name: req.body.session + "/contexts/ask_location", lifespanCount: 5 }]
    });
}

function askLocation(req, res) {
    let location = req.body.queryResult.parameters.location || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸";
    if(Array.isArray(location)){location = location[0];
    }  // à¹à¸à¹‰à¹„à¸‚à¸›à¸±à¸à¸«à¸²à¸à¸²à¸£à¸£à¸±à¸šà¸„à¹ˆà¸²à¸ˆà¸²à¸ Dialogflow
    location = location.replace(/(à¹„à¸›|à¸—à¸µà¹ˆ|à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”|à¹€à¸—à¸µà¹ˆà¸¢à¸§|à¸­à¸¢à¸¹à¹ˆ|à¸„à¹ˆà¸°|à¸„à¸£à¸±à¸š)/g, "").trim();  // à¸¥à¸šà¸„à¸³à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™à¸­à¸­à¸

    // âœ… à¸«à¸²à¸ à¸¹à¸¡à¸´à¸ à¸²à¸„à¸‚à¸­à¸‡à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”
    let region = Object.keys(regions).find(key => regions[key].includes(location)) || null;
    console.log("location:", location, "region:", region);

    // âœ… à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸žà¸šà¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¹ƒà¸™à¸£à¸²à¸¢à¸à¸²à¸£
    if (!region) {
        res.json({
            fulfillmentText: `à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° ðŸ˜¢ à¸™à¹‰à¸­à¸‡ Speedà¹‚à¸¡à¹ˆà¹„à¸¡à¹ˆà¸žà¸šà¸ˆà¸±à¸‡à¸«à¸§à¸±à¸” "${location}" à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸­à¸·à¹ˆà¸™ à¸¡à¸²à¸­à¸µà¸à¸—à¸µà¹„à¸”à¹‰à¹„à¸«à¸¡à¸„à¸°!`
        });
        return;
    }

    let recommendation = recommendations[region];
    console.log("recommendation:", recommendation);

    // âœ… à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰
    res.json({
        fulfillmentText: `à¸žà¸µà¹ˆà¹†à¸ˆà¸°à¹„à¸› **${location}** à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ${region}â€¼ï¸ à¹ƒà¸Šà¹ˆà¹„à¸«à¸¡à¸„à¸°?  ${recommendation} \n\nâœ¨ à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹à¸™à¸°à¸™à¸³à¹€à¸žà¸´à¹ˆà¸¡à¹„à¸«à¸¡à¸„à¸°? âœ¨`,
        outputContexts: [{ name: req.body.session + "/contexts/await_yes_no", lifespanCount: 5 }]
    });
}

function asklocationYes(req, res) {
    res.json({
        fulfillmentText: responsesAskLocationYes[Math.floor(Math.random() * responsesAskLocationYes.length)],
        outputContexts: [{ name: req.body.session + "/contexts/ask_location", lifespanCount: 5 }]
    });
}

function asklocationNo(req, res) {
    res.json({ fulfillmentText: responsesNoGoodbye[Math.floor(Math.random() * responsesNoGoodbye.length)] });
}


// ðŸ”¹ Webhook Endpoint
app.post("/webhook", (req, res) => {
    const intent = req.body.queryResult.intent.displayName;

    const intentMap = new Map();
    intentMap.set("sayhi", sayHi);
    intentMap.set("ask_location", askLocation);
    intentMap.set("ask_location-yes", asklocationYes);
    intentMap.set("ask_location-no", asklocationNo);

    if (intentMap.has(intent)) {
        intentMap.get(intent)(req, res);
    } else {
        res.json({ fulfillmentText: "à¸‚à¸­à¹‚à¸—à¸©à¸„à¹ˆà¸° Speedà¹‚à¸¡à¹ˆ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸„à¸³à¸‚à¸­à¸‡à¸„à¸¸à¸“ ðŸ˜¢\n à¸ˆà¸°à¹€à¸£à¸µà¸¢à¸™à¸£à¸¹à¹‰à¹ƒà¸«à¹‰à¸¡à¸²à¸à¸à¸§à¹ˆà¸²à¸™à¸µà¹‰à¸™à¸°à¸„à¸° \n à¸à¸£à¸¸à¸“à¸²à¸—à¸±à¸à¸—à¸²à¸¢à¹ƒà¸«à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¸¢à¸„à¹ˆà¸°" });
    }
});

// ðŸ”¹ à¹€à¸›à¸´à¸”à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
    console.log(`ðŸš€ Webhook is running on port ${PORT}`);
});